<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<script>
		var host = "michelenasti.com";
		if ((host == window.location.host) && (window.location.protocol != "https:"))
			window.location.protocol = "https";
	</script>
	
	<title>Become a test expert in NodeJS with these tricks - Michele Nasti's blog</title>
	 
	<meta name="keywords" content="testing, nodejs, async, express" />  
	<meta http-equiv="last-modified" content="2017-09-19 10:17:10 +0200" /> 
	<!--<noscript>-->
	<link rel="stylesheet" href="/css/skel.css" />
	<link rel="stylesheet" href="/css/style.css" />
	<link rel="stylesheet" href="/css/style-xlarge.css" />
	<link rel="stylesheet" href="/css/colorful.css" />
	<link rel="stylesheet" href="/css/social.css" />
	<link rel="stylesheet" href="/node_modules/animate.css/animate.min.css" />
	<meta name="google-site-verification" content="wpVjnRuXV99CAZxjYBzZgKbJm-8_tdLPrlP43u9zhV0" /> <!-- facebook Open Graph Metadatas -->
<meta content="your_facebook_app_id" property="fb:app_id">
<meta content="" property="og:site_name">


  <meta content="Become a test expert in NodeJS with these tricks" property="og:title">



  <meta content="article" property="og:type">



  <meta content="I'm a full stack Developer with an eye for the web." property="og:description">



  <meta content="https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html" property="og:url">



  <meta content="2017-03-27T12:55:00+02:00" property="article:published_time">
  <meta content="https://www.facebook.com/micnasti/" property="article:author">



<meta content="/img/logo-high-resolution.png" property="og:image">



  
  <meta content="testing" property="article:tag">
  
  <meta content="nodejs" property="article:tag">
  
  <meta content="async" property="article:tag">
  
  <meta content="express" property="article:tag">
  


<!-- Twitter cards metadatas -->
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@vdaubry">
<meta name="twitter:creator" content="@micnasti">

  <meta name="twitter:title" content="Become a test expert in NodeJS with these tricks">


  <meta name="twitter:url" content="https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html">



  <meta name="twitter:description" content="I'm a full stack Developer with an eye for the web.">



	<!--</noscript>-->
	<!--[if lte IE 8]><link rel="stylesheet" href="/css/ie/v8.css" /><![endif]-->
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-88764277-1', 'auto');
  ga('send', 'pageview');

</script>
	<link rel="stylesheet" href="/css/prism.css" />
	
</head>

<body id="top">

	<header id="header">
	<a href="#" class="image avatar"><img src="/images/michele_nasti.jpg" alt="michele nasti volto" /></a>
	<h1><strong><a href="/">Michele Nasti</a></strong><br /> Full-stack developer <br> with an eye for the web<br>
	</h1>
<a href="/chi-sono-michele-nasti/">Chi sono</a> | 
<a href="/talks-conferences/">Talks &amp; Conferences</a> | 
<a href="/archives/">Archives</a>

</header> <div id="main">
	<article>
		<header class="major">
			<h1 class="post-title"><a href="/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html">Become a test expert in NodeJS with these tricks</a></h1>
			<p class="post-meta">Mar 27, 2017 • musikele</p>
		</header>

		<section>
			
<ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html&t=" title="Share on Facebook" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html) + '&t=' + encodeURIComponent(document.title)); return false;"><img alt="Share on Facebook" src="/images/icons/Facebook.svg"></a></li>
  <li><a href="https://twitter.com/intent/tweet?source=https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html&text=Become a test expert in NodeJS with these tricks:%20https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html&via=micnasti" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(Become a test expert in NodeJS with these tricks) + ':%20'  + encodeURIComponent(https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html)); return false;"><img alt="Tweet" src="/images/icons/Twitter.svg"></a></li>
  <li><a href="https://plus.google.com/share?url=https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html" target="_blank" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=' + encodeURIComponent(https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html)); return false;"><img alt="Share on Google+" src="/images/icons/Google+.svg"></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html&title=Become a test expert in NodeJS with these tricks&summary=&source=https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html" target="_blank" title="Share on LinkedIn" onclick="window.open('http://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html) + '&title=' +  encodeURIComponent(document.title)); return false;"><img alt="Share on LinkedIn" src="/images/icons/LinkedIn.svg"></a></li>
</ul>
			
			<p>After reading my first guide to 
<a href="https://michelenasti.com/2017/03/23/node-js-testing-easy-with-mocha.html">testing NodeJS with Mocha</a> you might have grasped the fundamental concepts of NodeJS testing. However, <strong>real word code is usually tested with some other expedients</strong> that you might know to be a better tester (and coder).</p>

<h2 id="using-an-assertion-library">Using an assertion library</h2>

<p>In my previous article I wrote how to check the test result: to set a test as failing, you throw a <code>new Error()</code> object with the message to show.</p>

<p>This is the naive approach; the default is to use an assertion library. These libraries will expose an API that is clearer and simpler to manage, and will let you test more conditions with less code. Under the hood, they will launch the <code>new Error()</code> if the conditions are not respected.</p>

<p>Let’s see one of these libraries. One of the most famous libraries is called 
<a href="https://github.com/mjackson/expect"><code>expect</code></a>:</p>
<blockquote>
<p>When you use expect, you write assertions similarly to how you would say them, e.g. "I expect this value to be equal to 3" or "I expect this array to contain 3". When you write assertions in this way, you don't need to remember the order of actual and expected arguments to functions like assert.equal, which helps you write better tests.</p>
</blockquote>

<p>Let’s see an example. Here is the test for a <code>add</code> function, and the test is contained in file <code>utils.test.js</code>:</p>

<pre><code>//utils.test.js
const expect = require('expect');

const utils = require('./utils');

it('should add two numbers', () =&gt; {
  let res = utils.add(33, 11);

  expect(res).toBe(44).toBeA('number');
});
</code></pre>

<p>Easier to write, and to reason about. with <code>expect</code> you can also check if objects have properties, etc. Have a look on their website to see all aviable methods.</p>

<h2 id="testing-async-code">Testing async code</h2>

<p>If you’re using NodeJS, or Javascript, you’re also probably using async functions. No matter if it’s in the form of promises or callbacks, stuff in JS happens async, and we must deal with it.</p>

<p>Let’s prepare an example async function:</p>

<pre><code>//utils.js
module.exports.asyncAdd = (a,b, callback) =&gt; {
  setTimeout(() =&gt; {
    callback(a+b);
  }, 1000);
}

</code></pre>

<p>How do we test it? The first approach we might think would be to write the test like before:</p>

<pre><code>//utils.test.js
it('should add two numbers', () =&gt; {
  let res = utils.asyncAdd(33, 11, (res) =&gt; {
  
    // will this work? 
    expect(res).toBe(44).toBeA('number'); 
  });
});

</code></pre>

<p>If you launch this example, <em>the test will pass, but for the <strong>wrong reason</strong></em>. Infact, Mocha will not wait the result callback an will end the test instantly. Try to break the test or the function… Mocha will say that everything is ok. That’s not good.</p>

<p>How can we fix this? Mocha has a super-simple solution, just add a <code>done</code> argument to the test callback. When <code>done</code> is present, Mocha will not end the test before you call the <code>done()</code> function. Let’s try:</p>

<pre><code>//utils.test.js
it('should add two numbers', (done) =&gt; {
  let res = utils.asyncAdd(33, 11, (res) =&gt; {
  
    expect(res).toBe(44).toBeA('number'); 
    done();
  });
});

</code></pre>

<p>Now, if you try to break the test or the function, you’ll see that Mocha will fail. Exactely what we want.</p>

<h2 id="testing-an-express-application">Testing an Express application</h2>

<p>It’s very difficult for the random developer to write a NodeJS app without using <a href="https://expressjs.com/it/">Express</a>, a framework for web applicatons that allows you to write REST endpoints easily.</p>

<p>How do I test an express application?</p>

<p>the creators of Express have come in help by creating another library called <a href="https://github.com/visionmedia/supertest">supertest</a>:</p>

<blockquote>
  <p> HTTP assertions made easy via superagent.</p>
</blockquote>

<p>Let’s write a simple http application with Express:</p>

<pre><code class="language-javascript">//file server.js
const express = require('express');

const app = express();

app.get('/', (req, res) =&gt; {
  res.status(404).send({
    error: 'Page not found',
    name: 'hello baby'
  });
});

app.listen(3000);
module.exports.app = app; // (1)
</code></pre>

<p>This simple express app will return a <code>404</code> error with a json payload, everytime you navigate to <code>http://localhost:3000/</code>. Why? Because there’s nothing to see, obviously! :p</p>

<p>The only point worth of noting is that we simply export the app, as every other node module. Adding this line at (1) does not break anything, and makes testing possible.</p>

<p>To test this app, let’s write the test using <em>supertest</em>:</p>

<pre><code class="language-javascript">//server.test.js

const request = require('supertest');
const expect = require('expect');

const app = require('./server');

it('should return hello world response', (done) =&gt; {
  request(app)          // (1)
    .get('/')           // (2)
    //supertest expect!!
    .expect(404)        // (3)
    .expect((res) =&gt; {  // (4)
      //expect library! 
      expect(res.body).toInclude({
        error: 'Page not found'
      })
    })
    .end(done);         // (5)
});
</code></pre>

<p>That’s interesting. At (1) we are importing the express app and using <code>supertest</code> to wrap it. Then we perform a <code>get</code> request over <code>/</code> (2) and start expecting things about the result. Unfortunately, supertest has another <code>expect</code> method that is not related to the one in the <code>expect</code> library.</p>

<p>By the way, with supertest we can make assumptions about the status code (3), and if we want to assert something about the body of the request, we can do like in (4): when using a callback we can do everything over the <code>res</code> variable, and infact we are using the <code>expect</code> library to see if the body includes the <code>error</code> property.</p>

<p>Since this Mocha test is async, we need a way to tell mocha that the test has ended. In (5) we see that supertest is already aware of mocha and will stop the test by passing the <code>done</code> function to <code>end()</code>.</p>

<h2 id="conclusions">Conclusions</h2>

<p>For a novice, the problem of testing Node apps is that there are many libraries the same thing. For an expert, this becomes an advantage: you can choose the best for your purposes (but you must know them in advance).</p>

<p>By the way, testing is important. Test everything is testable. Otherwise, maintaining javascript code can only be a mess.</p>
 
			
			
<ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html&t=" title="Share on Facebook" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html) + '&t=' + encodeURIComponent(document.title)); return false;"><img alt="Share on Facebook" src="/images/icons/Facebook.svg"></a></li>
  <li><a href="https://twitter.com/intent/tweet?source=https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html&text=Become a test expert in NodeJS with these tricks:%20https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html&via=micnasti" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(Become a test expert in NodeJS with these tricks) + ':%20'  + encodeURIComponent(https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html)); return false;"><img alt="Tweet" src="/images/icons/Twitter.svg"></a></li>
  <li><a href="https://plus.google.com/share?url=https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html" target="_blank" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=' + encodeURIComponent(https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html)); return false;"><img alt="Share on Google+" src="/images/icons/Google+.svg"></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html&title=Become a test expert in NodeJS with these tricks&summary=&source=https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html" target="_blank" title="Share on LinkedIn" onclick="window.open('http://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html) + '&title=' +  encodeURIComponent(document.title)); return false;"><img alt="Share on LinkedIn" src="/images/icons/LinkedIn.svg"></a></li>
</ul>

			<h4>Related Posts:</h4>
<div class="articles-row">







    
    

    

    
        <div class="col-4">
        <h5><a href="/2018/10/29/the-easiest-way-to-understand-javascript-generators.html">The easiest way to understand Javascript Generators <span class="label label-default">nodejs</span> </a></h5>
        </div>
        
         
    



    
    

    

    



    
    

    

    



    
    

    

    
        <div class="col-4">
        <h5><a href="/2018/10/15/dovrei-imparare-ruby-on-rails-o-nodejs.html">Dovrei imparare Ruby on Rails o NodeJS ?  <span class="label label-default">nodejs</span> </a></h5>
        </div>
        
         
    



    
    

    

    
        <div class="col-4">
        <h5><a href="/2018/10/02/let-s-write-a-simple-version-of-the-require-function.html">Let's write our simple version of the require() function <span class="label label-default">nodejs</span> </a></h5>
        </div>
        
         
    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    
        <div class="col-4">
        <h5><a href="/2018/08/22/ma-cosa-intendete-per-testing-una-breve-introduzione-al-testing-software.html">"ma... cosa intendete per testing?" - una breve introduzione al testing software  <span class="label label-default">testing</span> </a></h5>
        </div>
        
        
            



    


</div>

		</section>

		<section>
			 <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    
    var disqus_config = function () {
    	//var disqus_identifier = 'https://michelenasti.com';
			//var disqus_url = '';
			var disqus_url = 'https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html';
			var disqus_identifier = 'https://michelenasti.com/2017/03/27/become-a-test-expert-in-nodejs-with-these-tricks.html';

    };
    
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//michele-nastis-blog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> 
		</section>

		<footer>			
			<div>
    

    <div class="6u 12u(small) excerpt" id="previousArticle">
        <header>
            <h2><a href="/2017/03/23/node-js-testing-easy-with-mocha.html">Easy testing of NodeJS applications with Mocha</a></h2>
        </header>
        <section>
            <p>Testing in Javascript has become an immensely popular argument, but still there’s a lot of people that has not clear how to do it effectively. <a href="/2016/08/my-very-personal-javascript-fatigue/">I was one of these</a>. There are many troubles that a young developer has to overcome in order to master Javascript testing. In this article, I’m going to explain Javascript testing with Mocha, a powerful library.</p>


        </section>
        <div>
            <ul class="actions">
                <li><a href="/2017/03/23/node-js-testing-easy-with-mocha.html" class="button">Read More</a></li>
            </ul>
        </div>
    </div>
     

    <div class="6u$ 12u(small) excerpt f-right" id="nextArticle">
        <header>
            <h2><a href="/2017/04/07/fantastic-unit-tests-in-javascript-with-mocks.html">Fantastic Unit Tests in Javascript with Mocks</a></h2>
        </header>
        <section>
            <p>Let’s start with the example. We have two files, one that is the main one called <code>app.js</code> that exports just one method, called <code>handleSignup()</code>:</p>


        </section>
        <div>
            <ul class="actions">
                <li><a href="//2017/04/07/fantastic-unit-tests-in-javascript-with-mocks.html" class="button">Read More</a></li>
            </ul>
        </div>
    </div>
    
</div>
		</footer>

	</article>

</div>
<script src="/js/infinite-scroll.js"></script>

	<!-- Footer -->
	<footer id="footer">
	<ul class="icons">

		
		<li>
			<a href="https://github.com/musikele" class="icon fa-github">
				<span class="label">GitHub</span>
			</a>
		</li>
		 
		<li>
			<a href="https://twitter.com/micnasti" class="icon fa-twitter">
				<span class="label">Twitter</span>
			</a>
		</li>
		 
		<li>
			<a href="https://linkedin.com/in/michelenasti" class="icon fa-linkedin">
				<span class="label">LinkedIn</span>
			</a>
		</li>
		 
		<li>
			<a href="https://plus.google.com/+MicheleNasti" class="icon fa-google-plus">
				<span class="label">Google+</span>
			</a>
		</li>
		 
		<li>
			<a href="https://www.facebook.com/musikele" class="icon fa-facebook">
				<span class="label">Facebook</span>
			</a>
		</li>
		  
	</ul>
	<ul class="copyright">
		<li>&copy; Michele Nasti</li>
		<li>Based on <a href="http://html5up.net/strata">STRATA</a> theme</li>
	</ul>
</footer>
	<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
	<script src="/js/jquery.min.js"></script>
	<script src="/js/jquery.poptrox.min.js"></script>
	<script src="/js/skel.min.js"></script>
	<script src="/js/init.js"></script>
	<script src="/js/prism.js"></script>
	<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#000"
    },
    "button": {
      "background": "#f1d600"
    }
  },
  "position": "bottom-left",
  "content": {
    "href": "//www.iubenda.com/privacy-policy/84379975"
  }
})});
</script>
	<!-- <script src="/js/badge.js"></script> -->
</body>

</html>
