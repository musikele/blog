<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<script>
		var host = "michelenasti.com";
		if ((host == window.location.host) && (window.location.protocol != "https:"))
			window.location.protocol = "https";
	</script>
	
	<title>How ads are loaded so fast: the command queue pattern - Michele Nasti's blog</title>
	 
	<meta name="keywords" content="" />  
	<meta http-equiv="last-modified" content="2019-02-15 11:55:44 +0100" /> 
	<!--<noscript>-->
	<link rel="stylesheet" href="/css/skel.css" />
	<link rel="stylesheet" href="/css/style.css" />
	<link rel="stylesheet" href="/css/style-xlarge.css" />
	<link rel="stylesheet" href="/css/colorful.css" />
	<link rel="stylesheet" href="/css/social.css" />
	<link rel="stylesheet" href="/node_modules/animate.css/animate.min.css" />
	<meta name="google-site-verification" content="wpVjnRuXV99CAZxjYBzZgKbJm-8_tdLPrlP43u9zhV0" /> <!-- facebook Open Graph Metadatas -->
<meta content="your_facebook_app_id" property="fb:app_id">
<meta content="" property="og:site_name">


  <meta content="How ads are loaded so fast: the command queue pattern" property="og:title">



  <meta content="article" property="og:type">



  <meta content="The command queue pattern allows you to give commands to your library, even if it has still not been loaded. This technique is widely used in advertising. " property="og:description">



  <meta content="https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html" property="og:url">



  <meta content="2019-02-12T00:00:00+01:00" property="article:published_time">
  <meta content="https://www.facebook.com/micnasti/" property="article:author">



<meta content="https://michelenasti.com///images/command_queue_pattern-2.jpg" property="og:image">



  


<!-- Twitter cards metadatas -->
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@vdaubry">
<meta name="twitter:creator" content="@micnasti">

  <meta name="twitter:title" content="How ads are loaded so fast: the command queue pattern">


  <meta name="twitter:url" content="https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html">



  <meta name="twitter:description" content="The command queue pattern allows you to give commands to your library, even if it has still not been loaded. This technique is widely used in advertising. ">



  <meta name="twitter:image:src" content="https://michelenasti.com//images/command_queue_pattern-2.jpg">

	<!--</noscript>-->
	<!--[if lte IE 8]><link rel="stylesheet" href="/css/ie/v8.css" /><![endif]-->
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-88764277-1', 'auto');
  ga('send', 'pageview');

</script>
	<link rel="stylesheet" href="/css/prism.css" />
	
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-9588917209740632",
        enable_page_level_ads: true
    });
</script>
</head>

<body id="top">

	<header id="header">
	<a href="#" class="image avatar"><img src="/images/michele_nasti.jpg" alt="michele nasti volto" /></a>
	<h1><strong><a href="/">Michele Nasti</a></strong><br /> Full-stack developer <br> with an eye for the web<br>
	</h1>
<a href="/chi-sono-michele-nasti/">Chi sono</a> | 
<a href="/talks-conferences/">Talks &amp; Conferences</a> | 
<a href="/archives/">Archives</a>

</header> <div id="main">
	<article>
		<header class="major">
			<h1 class="post-title"><a href="/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html">How ads are loaded so fast: the command queue pattern</a></h1>
			<p class="post-meta">Feb 12, 2019 • musikele</p>
		</header>

		<section>
			
			<p>Prior to work in an ads company I had no idea of how ads are actually rendered on a page. I mean, I had a vague sense of what was going on, but the actual world behind it … well, it’s huge :)</p>

<p>Sometimes ads are loaded on a page even before you actually see any content. How? The first thing we learned at university is to wait for the DOM to have completely loaded, before doing anything to the DOM itself. This does not apply to ads, or better to say, ad companies use many tricks to load ads without blocking the DOM.</p>

<p>I won’t go in the detail of this process now, but basically <strong>ads are rendered inside <em>iframes</em></strong>, and iframes should be used only for very narrow use cases, like widgets to inject on other pages, or payment processors. In the past I did the exact opposite: we implemented an angular 1 routing system with iframes, and that’s something I wouldn’t do again (<a href="https://michelenasti.com/2015/05/iframe-safari-ios-e-la-lotta-allultimo-millisecondo/">my experience</a> - in italian).</p>

<p>Here in this article I’m going to talk about how some popular ad libraries (like <a href="https://support.google.com/admanager/answer/1638622?hl=en&amp;ref_topic=4390039">google publisher tag</a> or <a href="http://prebid.org/dev-docs/getting-started.html">Prebid</a>) allow users to write code that will be put in a queue and will be executed as soon as the library is loaded.</p>

<h2 id="the-problem-async-library-loading">The problem: async library loading</h2>

<p>Suppose we have a library that will load something, and this initialization process will take some time. Also, we don’t know when the library will be actually loaded, since it’s asyncronous. However, we would like to start giving commands (e.g. setup instructions) to this library as soon as possible. How?</p>

<blockquote>
  <p>Let’s suppose our library’s name is, without much fantasy, <code>Library</code> and is loaded from file <code>Library.js</code>.</p>
</blockquote>

<h2 id="the-client-code">The client code</h2>

<p>in the client’s code, the code that the user will write to interact with our library, we will initialize the library like this:</p>

<pre><code class="language-javascript">var Library = Library || {}; 
Library.queue = Library.queue || [];
</code></pre>

<p>In these two simple lines, we have initialized our library and its commands queue. In fact, if the <code>Library</code> object does not exist, we will initialize it with an empty object, and then we will create the empty array property <code>Library.queue</code> that will contain our initalization code. For example:</p>

<pre><code class="language-javascript">Library.queue.push(function(){
	console.log("Called only when the library has loaded, not before");
	Library.doMagic();
});
</code></pre>

<blockquote>
  <p>Note: I’m deliberately using ES5 code here. It would be fantastic that every user in the world was using the latest version of the coolest browser, but the reality is that <strong>a bunch of zombies are still using Internet Explorer</strong>. Ad companies want to earn money on these people too!</p>
</blockquote>

<h2 id="how-we-load-the-library">How we load the Library</h2>

<p>Imagine we load our library with this <code>script</code> tag:</p>

<pre><code class="language-html">&lt;script src="/path/to/Library.js" async defer&gt;&lt;/script&gt;
</code></pre>

<p><code>async</code> means that the browser will download the library as soon as possible, but the evaluation will start whenever it is more convenient (the browser decides). The HTML parser is paused when the script is evluated. <code>defer</code> means the same thing (more or less!) but the code execution happens only after the DOM has been loaded. <a href="https://www.growingwiththeweb.com/2014/02/async-vs-defer-attributes.html" title="async vs defer">More info here</a>.</p>

<p>By inserting the <code>async</code> and <code>defer</code> keyword we don’t have any guarantee of the Library execution time, so we don’t know who will be loaded first.</p>

<h2 id="the-library-internals">The Library internals</h2>

<p>Here’s an example of how the Library could initialize itself:</p>

<pre><code class="language-javascript">//This code could be in file Library.js 
 
var Library = (function() {
  ...
  var queue = []; 
  if (Library) {
    // queue from outside might be null... 
    queue = Library.queue || queue;
  } 
  //here we execute code that is in the queue
  while (queue.length &gt; 0) {
    var command = queue.shift(); 
    command();
  }
  ...
})()
</code></pre>

<p>First we will check if the <code>Library</code> object already exists. This may be because of the initialization we did in the client code. If so, we take the queue object and start executing all commands from the queue, until the queue is empty.</p>

<h2 id="thats-so-async-its-actually-fast">That’s so async, it’s actually fast</h2>

<p>By not forcing the browser to stop and parse our js, we gain a significant amount of perceived speed. And by splitting the client code in <em>commands</em> we also get the guarantee that the client code will be executed.</p>

<p>In this simple snippet we have not covered other themes like:</p>

<ul>
  <li>what if we add another element to the queue after the initialization has already completed?</li>
  <li>A way of logging functions (yes, we can stringify functions) and remember a history of executed functions</li>
</ul>

<p>That’s an exercise for you, fellow readers!</p>
 
			
			
<ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html&t=" title="Share on Facebook" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html) + '&t=' + encodeURIComponent(document.title)); return false;"><img alt="Share on Facebook" src="/images/icons/Facebook.svg"></a></li>
  <li><a href="https://twitter.com/intent/tweet?source=https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html&text=How ads are loaded so fast: the command queue pattern:%20https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html&via=micnasti" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(How ads are loaded so fast: the command queue pattern) + ':%20'  + encodeURIComponent(https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html)); return false;"><img alt="Tweet" src="/images/icons/Twitter.svg"></a></li>
  <li><a href="https://plus.google.com/share?url=https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html" target="_blank" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=' + encodeURIComponent(https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html)); return false;"><img alt="Share on Google+" src="/images/icons/Google+.svg"></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html&title=How ads are loaded so fast: the command queue pattern&summary=&source=https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html" target="_blank" title="Share on LinkedIn" onclick="window.open('http://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html) + '&title=' +  encodeURIComponent(document.title)); return false;"><img alt="Share on LinkedIn" src="/images/icons/LinkedIn.svg"></a></li>
</ul>

			<h4>Related Posts:</h4>
<div class="articles-row">







    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    



    
    

    

    





    
        
        
        
        
        

        <div class="col-4">
            <h5><a href="/2018/05/06/proteggi-le-tue-applicazioni-express-con-helmetjs.html">Proteggi le tue applicazioni Express con HelmetJs</a></h5>
        </div>
    
        
        
        
        
        

        <div class="col-4">
            <h5><a href="/2017/10/03/recensione-dell-xps-15-2017.html">Windows non fa più così schifo: recensione Dell XPS 15" 9560 (2017)</a></h5>
        </div>
    
        
        
        
        
        

        <div class="col-4">
            <h5><a href="/2017/03/14/two-easy-ways-perform-get-requests-in-nodejs.html">Two easy ways perform GET requests in NodeJS </a></h5>
        </div>
    
        
        
        
        
        

        <div class="col-4">
            <h5><a href="/2016/11/build-your-own-cross-platform-time-machine/">I was not satisfied with Time Machine so I wrote my own Backup System</a></h5>
        </div>
    


</div>

		</section>

		<section>
			 <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    
    var disqus_config = function () {
    	//var disqus_identifier = 'https://michelenasti.com';
			//var disqus_url = '';
			var disqus_url = 'https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html';
			var disqus_identifier = 'https://michelenasti.com/2019/02/12/how-ads-are-loaded-so-fast-the-command-queue-pattern.html';

    };
    
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//michele-nastis-blog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> 
		</section>

		<footer>			
			<div>
    

    <div class="6u 12u(small) excerpt" id="previousArticle">
        <header>
            <h2><a href="/2019/01/23/is-typescript-namespace-feature-deprecated.html">Is typescript Namespace feature deprecated? </a></h2>
        </header>
        <section>
            <p>At my new job I maintain a medium-sized typescript library that is critical to the success of the company.</p>


        </section>
        <div>
            <ul class="actions">
                <li><a href="/2019/01/23/is-typescript-namespace-feature-deprecated.html" class="button">Read More</a></li>
            </ul>
        </div>
    </div>
     

    <div class="6u$ 12u(small) excerpt f-right" id="nextArticle">
        <header>
            <h2><a href="/2019/03/23/what-s-the-difference-between-browserify-and-webpack.html">What's the difference between Browserify and Webpack?</a></h2>
        </header>
        <section>
            <p><strong>Browserify</strong> belongs to the very first generation of module bundlers and it basically allowed one thing, that is, use the <code>require</code> function from NodeJS in the browser. Browserify’s only job was to concatenate files wrapping them in functions that were then called by other fils.</p>


        </section>
        <div>
            <ul class="actions">
                <li><a href="//2019/03/23/what-s-the-difference-between-browserify-and-webpack.html" class="button">Read More</a></li>
            </ul>
        </div>
    </div>
    
</div>
		</footer>

	</article>

</div>
<script src="/js/infinite-scroll.js"></script>

	<!-- Footer -->
	<footer id="footer">
	<ul class="icons">

		
		<li>
			<a href="https://github.com/musikele" class="icon fa-github">
				<span class="label">GitHub</span>
			</a>
		</li>
		 
		<li>
			<a href="https://twitter.com/micnasti" class="icon fa-twitter">
				<span class="label">Twitter</span>
			</a>
		</li>
		 
		<li>
			<a href="https://linkedin.com/in/michelenasti" class="icon fa-linkedin">
				<span class="label">LinkedIn</span>
			</a>
		</li>
		 
		<li>
			<a href="https://plus.google.com/+MicheleNasti" class="icon fa-google-plus">
				<span class="label">Google+</span>
			</a>
		</li>
		 
		<li>
			<a href="https://www.facebook.com/musikele" class="icon fa-facebook">
				<span class="label">Facebook</span>
			</a>
		</li>
		  
	</ul>
	<ul class="copyright">
		<li>&copy; Michele Nasti</li>
		<li>Based on <a href="http://html5up.net/strata">STRATA</a> theme</li>
	</ul>
</footer>
	<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
	<script src="/js/jquery.min.js"></script>
	<script src="/js/jquery.poptrox.min.js"></script>
	<script src="/js/skel.min.js"></script>
	<script src="/js/init.js"></script>
	<script src="/js/prism.js"></script>
	<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#000"
    },
    "button": {
      "background": "#f1d600"
    }
  },
  "position": "bottom-left",
  "content": {
    "href": "//www.iubenda.com/privacy-policy/84379975"
  }
})});
</script>
	<!-- <script src="/js/badge.js"></script> -->
</body>

</html>
